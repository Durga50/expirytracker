<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeMeds - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="logo.png" type="image/png">

    <style>
        body {
            background: linear-gradient(120deg, #eaf8fd 0%, #f8f9fa 100%);
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            transition: background 0.7s;
        }
        .navbar {
            background: #00b0ea;
            box-shadow: 0 4px 24px 0 rgba(0, 176, 234, 0.08);
        }
        .navbar-brand {
            font-family: 'Pacifico', cursive;
            font-weight: bold;
            letter-spacing: 2px;
            color: #fff !important;
            font-size: 2rem;
            text-shadow: 1px 2px 8px #009cd6, 0 1px 0 #fff;
        }
        .user-name {
            color: #fff;
            font-weight: 500;
            margin-right: 1rem;
            font-size: 1.1rem;
        }
        .dashboard-title {
            font-weight: bold;
            color: #00b0ea;
            letter-spacing: 1px;
            font-size: 2.1rem;
            font-family: 'Pacifico', cursive;
            text-shadow: 1px 2px 8px #b2e6fa, 0 1px 0 #fff;
        }
        .search-bar {
            width: 100%;
            max-width: 320px;
            border-radius: 25px;
            border: 1.5px solid #00b0ea;
            padding: 10px 18px;
            font-size: 1.1em;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 8px rgba(0,176,234,0.07);
        }
        .search-bar:focus {
            border-color: #009cd6;
            box-shadow: 0 2px 8px rgba(0,176,234,0.08);
        }
        .medicine-card {
            border: 2px solid #00b0ea;
            padding: 18px 12px 14px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 12px 0 rgba(0, 176, 234, 0.10);
            margin-bottom: 22px;
            transition: transform 0.3s cubic-bezier(.4,2,.6,1), box-shadow 0.3s, background 0.3s, border-color 0.3s;
            animation: fadeInUp 0.7s;
            background: #eaf8fd;
            opacity: 0;
            animation: cardFadeIn 0.7s forwards;
            position: relative;
        }
        @keyframes cardFadeIn {
            from { opacity: 0; transform: translateY(30px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .medicine-card.expired {
            background: #ffeaea !important;
            border-color: #ff3b3b;
        }
        .medicine-card.expiring-soon {
            background: #fff3e0 !important;
            border-color: #ff9800;
        }
        .medicine-card.safe {
            background: #eaf8fd !important;
            border-color: #00b0ea;
        }
        .medicine-card:hover {
            transform: translateY(-8px) scale(1.045) rotate(-1deg);
            box-shadow: 0 12px 36px 0 rgba(0, 176, 234, 0.18);
            border-color: #009cd6;
            background: #f0faff;
        }
        .card-actions {
            display: none;
            gap: 8px;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2;
        }
        .medicine-card:hover .card-actions {
            display: flex;
        }
        .icon-btn {
            background: none;
            border: none;
            color: #00b0ea;
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.2s;
        }
        .icon-btn.delete {
            color: #ff3b3b;
        }
        .icon-btn:hover {
            color: #009cd6;
        }
        .icon-btn.delete:hover {
            color: #d32f2f;
        }
        .card-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #00b0ea;
            text-align: center;
            margin-bottom: 10px;
            letter-spacing: 1px;
            margin-top: 28px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
            transition: color 0.3s, background 0.3s;
        }
        .card-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 18px;
            font-size: 0.98em;
            color: #333;
        }
        .card-info span {
            font-weight: 500;
            font-size: 0.97em;
            transition: color 0.3s;
        }
        .btn-primary, .btn-light {
            box-shadow: 0 2px 8px rgba(0,176,234,0.08);
            transition: background 0.3s, box-shadow 0.3s, color 0.3s;
        }
        .btn-primary:active, .btn-light:active {
            transform: scale(0.97);
        }
        .btn-primary {
            background: #00b0ea;
            border: none;
            border-radius: 20px;
            font-weight: 500;
        }
        .btn-primary:hover {
            background: #009cd6;
        }
        .swal2-popup {
            font-size: 1.1rem !important;
            font-family: 'Poppins', sans-serif;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 991px) {
            .dashboard-title { font-size: 1.5rem; }
        }
        @media (max-width: 767px) {
            .dashboard-title { font-size: 1.2rem; }
            .search-bar { max-width: 100%; margin-top: 10px; }
        }
        .medicine-tabs {
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
            animation: fadeIn 1s;
        }
        .nav-pills .nav-link {
            color: #00b0ea;
            border-radius: 20px;
            padding: 8px 20px;
            margin-right: 10px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(.4,2,.6,1);
            background: #eaf8fd;
        }
        .nav-pills .nav-link:hover {
            background-color: #eaf8fd;
        }
        .nav-pills .nav-link.active {
            background: linear-gradient(90deg, #00b0ea 60%, #009cd6 100%);
            color: white;
            box-shadow: 0 2px 12px rgba(0,176,234,0.10);
        }
        .tab-content > .tab-pane {
            transition: opacity 0.5s cubic-bezier(.4,2,.6,1);
        }
        .tab-content > .tab-pane:not(.active) {
            opacity: 0;
            pointer-events: none;
            height: 0;
        }
        .tab-content > .tab-pane.active {
            opacity: 1;
            height: auto;
        }
        .footer {
            width: 100%;
            background: #00b0ea;
            color: #fff;
            text-align: center;
            padding: 12px 0 8px 0;
            font-size: 1.08em;
            font-family: 'Poppins', sans-serif;
            letter-spacing: 1px;
            position: fixed;
            left: 0;
            bottom: 0;
            z-index: 100;
            box-shadow: 0 -2px 12px 0 rgba(0, 176, 234, 0.08);
            animation: fadeIn 1.2s 0.5s both;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">SafeMeds</a>
            <div class="d-flex align-items-center ms-auto">
                <span class="user-name" id="userName"></span>&nbsp;&nbsp;
                <button class="btn btn-light me-2" id="langSwitcher" onclick="toggleLanguage()" title="Switch Language"><i class="fas fa-globe"></i></button>
                <button class="btn btn-light" onclick="logout()"><b id="logoutBtnText">Logout</b></button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2 gap-md-0">
            <h2 class="dashboard-title mb-0" id="dashboardTitle">My Medicines</h2>
            <div class="d-flex align-items-center gap-2">
                <input type="text" class="search-bar ms-md-3" id="searchBar" placeholder="Search by name or expiry date">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicineModal">
                    <i class="fas fa-plus"></i> <span id="addMedicineBtnText">Add Medicine</span>
                </button>
            </div>
        </div><br><br>
        <div class="medicine-tabs mb-4">
            <ul class="nav nav-pills" id="medicineTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="pill" data-bs-target="#all" type="button" role="tab" aria-selected="true">All</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="unexpired-tab" data-bs-toggle="pill" data-bs-target="#unexpired" type="button" role="tab" aria-selected="false">Unexpired</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="expiring-soon-tab" data-bs-toggle="pill" data-bs-target="#expiring-soon" type="button" role="tab" aria-selected="false">Expiring Soon</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="expired-tab" data-bs-toggle="pill" data-bs-target="#expired" type="button" role="tab" aria-selected="false">Expired</button>
                </li>
            </ul>
        </div><br>
        <div class="tab-content" id="medicineTabsContent">
            <div class="tab-pane fade show active" id="all" role="tabpanel">
                <div class="row" id="allMedicines">
                    <!-- All medicines will be displayed here -->
                </div>
            </div>
            <div class="tab-pane fade" id="unexpired" role="tabpanel">
                <div class="row" id="unexpiredMedicines">
                    <!-- Unexpired medicines will be displayed here -->
                </div>
            </div>
            <div class="tab-pane fade" id="expiring-soon" role="tabpanel">
                <div class="row" id="expiringSoonMedicines">
                    <!-- Expiring soon medicines will be displayed here -->
                </div>
            </div>
            <div class="tab-pane fade" id="expired" role="tabpanel">
                <div class="row" id="expiredMedicines">
                    <!-- Expired medicines will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Medicine Modal -->
    <div class="modal fade" id="addMedicineModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMedicineModalTitle">Add New Medicine</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMedicineForm">
                        <div class="mb-3">
                            <label for="medicineName" class="form-label" id="addMedNameLabel">Medicine Name</label>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="medicineName" required>
                                <button class="btn btn-outline-secondary" type="button" id="addMedMicBtn" title="Speak" onclick="startSpeech('add','medicineName')"><i class="fas fa-microphone"></i></button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label" id="addMedQtyLabel">Quantity</label>
                            <div class="input-group mb-3">
                                <input type="number" class="form-control" id="quantity" required>
                                <button class="btn btn-outline-secondary" type="button" id="addQtyMicBtn" title="Speak" onclick="startSpeech('add','quantity')"><i class="fas fa-microphone"></i></button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="expiryDate" class="form-label" id="addMedExpLabel">Expiry Date</label>
                            <div class="input-group mb-3">
                                <input type="date" class="form-control" id="expiryDate" required>
                                <button class="btn btn-outline-secondary" type="button" id="addExpMicBtn" title="Speak" onclick="startSpeech('add','expiryDate')"><i class="fas fa-microphone"></i></button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addMedicine()" id="addMedSubmitBtn">Add Medicine</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Medicine Modal -->
    <div class="modal fade" id="editMedicineModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editMedicineModalTitle">Edit Medicine</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editMedicineForm">
                        <input type="hidden" id="editMedicineId">
                        <div class="mb-3">
                            <label for="editMedicineName" class="form-label" id="editMedNameLabel">Medicine Name</label>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="editMedicineName" required>
                                <button class="btn btn-outline-secondary" type="button" id="editMedMicBtn" title="Speak" onclick="startSpeech('edit','editMedicineName')"><i class="fas fa-microphone"></i></button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editQuantity" class="form-label" id="editMedQtyLabel">Quantity</label>
                            <div class="input-group mb-3">
                                <input type="number" class="form-control" id="editQuantity" required>
                                <button class="btn btn-outline-secondary" type="button" id="editQtyMicBtn" title="Speak" onclick="startSpeech('edit','editQuantity')"><i class="fas fa-microphone"></i></button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editExpiryDate" class="form-label" id="editMedExpLabel">Expiry Date</label>
                            <div class="input-group mb-3">
                                <input type="date" class="form-control" id="editExpiryDate" required>
                                <button class="btn btn-outline-secondary" type="button" id="editExpMicBtn" title="Speak" onclick="startSpeech('edit','editExpiryDate')"><i class="fas fa-microphone"></i></button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="updateMedicine()" id="editMedSubmitBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check if user is logged in
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) {
            window.location.href = '/index.html';
        }
        document.getElementById('userName').textContent = `Hi, ${user.username}`;

        let allMedicines = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadMedicines();
            document.getElementById('searchBar').addEventListener('input', filterMedicines);
            
            // Add event listeners for tab changes
            const tabButtons = document.querySelectorAll('.nav-pills .nav-link');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterMedicines();
                });
            });
            updateTexts();
        });

        async function loadMedicines() {
            try {
                const response = await fetch(`http://localhost:8080/api/medicines/user/${user.id}`);
                const medicines = await response.json();
                allMedicines = medicines;
                displayMedicines(medicines);
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error loading medicines',
                    background: '#eaf8fd',
                    color: '#00b0ea',
                });
            }
        }

        function getCardClass(expiryDate) {
            const today = new Date();
            const exp = new Date(expiryDate);
            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (days < 0) return 'medicine-card expired';
            if (days <= 7) return 'medicine-card expiring-soon';
            return 'medicine-card safe';
        }

        function getMedicineStatus(expiryDate) {
            const today = new Date();
            const exp = new Date(expiryDate);
            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (days < 0) return 'expired';
            if (days <= 7) return 'expiring-soon';
            return 'unexpired';
        }

        async function displayMedicines(medicines) {
            const allContainer = document.getElementById('allMedicines');
            const unexpiredContainer = document.getElementById('unexpiredMedicines');
            const expiringSoonContainer = document.getElementById('expiringSoonMedicines');
            const expiredContainer = document.getElementById('expiredMedicines');

            // Clear all containers
            allContainer.innerHTML = '';
            unexpiredContainer.innerHTML = '';
            expiringSoonContainer.innerHTML = '';
            expiredContainer.innerHTML = '';

            for (const medicine of medicines) {
                let displayName = medicine.name;
                if (currentLang === 'ta') {
                    displayName = await translateText(medicine.name, 'en', 'ta');
                }
                const cardClass = getCardClass(medicine.expiryDate);
                const status = getMedicineStatus(medicine.expiryDate);
                const card = `
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex align-items-stretch">
                        <div class="${cardClass} w-100 mb-3">
                            <div class="card-actions">
                                <button class="icon-btn" onclick="editMedicine(${medicine.id})" title="${t('Edit Medicine')}"><i class="fas fa-pen"></i></button>
                                <button class="icon-btn delete" onclick="deleteMedicine(${medicine.id})" title="${t('Delete Medicine')}"><i class="fas fa-trash"></i></button>
                            </div>
                            <div class="card-title" title="${displayName}">${displayName}</div>
                            <div class="card-info">
                                <span>${t('Quantity')}: ${medicine.quantity}</span>
                                <span>${t('Expiry Date')}: ${new Date(medicine.expiryDate).toLocaleDateString(currentLang === 'ta' ? 'ta-IN' : 'en-US')}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add to all medicines
                allContainer.innerHTML += card;
                
                // Add to specific category container
                switch(status) {
                    case 'unexpired':
                        unexpiredContainer.innerHTML += card;
                        break;
                    case 'expiring-soon':
                        expiringSoonContainer.innerHTML += card;
                        break;
                    case 'expired':
                        expiredContainer.innerHTML += card;
                        break;
                }
            }
        }

        function filterMedicines() {
            const query = document.getElementById('searchBar').value.trim().toLowerCase();
            const activeTab = document.querySelector('.nav-pills .nav-link.active').id;
            const filtered = allMedicines.filter(med => {
                const matchesSearch = med.name.toLowerCase().includes(query) ||
                    (med.expiryDate && med.expiryDate.includes(query));
                
                if (activeTab === 'all-tab') return matchesSearch;
                
                const status = getMedicineStatus(med.expiryDate);
                switch(activeTab) {
                    case 'unexpired-tab':
                        return matchesSearch && status === 'unexpired';
                    case 'expiring-soon-tab':
                        return matchesSearch && status === 'expiring-soon';
                    case 'expired-tab':
                        return matchesSearch && status === 'expired';
                    default:
                        return matchesSearch;
                }
            });
            displayMedicines(filtered);
        }

        async function addMedicine() {
            let name = document.getElementById('medicineName').value;
            const quantity = document.getElementById('quantity').value;
            const expiryDate = document.getElementById('expiryDate').value;
            // If currentLang is Tamil, translate to English before saving
            if (currentLang === 'ta') {
                name = await translateText(name, 'ta', 'en');
            }
            try {
                const response = await fetch('http://localhost:8080/api/medicines', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        quantity: parseInt(quantity),
                        expiryDate,
                        user: { id: user.id }
                    })
                });
                if (response.ok) {
                    document.getElementById('addMedicineForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addMedicineModal')).hide();
                    Swal.fire({
                        icon: 'success',
                        title: t('Medicine Added'),
                        showConfirmButton: false,
                        timer: 1200,
                        background: '#eaf8fd',
                        color: '#00b0ea',
                    });
                    loadMedicines();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: t('Error'),
                        text: t('Error adding medicine'),
                        background: '#eaf8fd',
                        color: '#00b0ea',
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: t('Error'),
                    text: t('Error adding medicine'),
                    background: '#eaf8fd',
                    color: '#00b0ea',
                });
            }
        }

        async function editMedicine(id) {
            try {
                const response = await fetch(`http://localhost:8080/api/medicines/${id}`);
                const medicine = await response.json();
                document.getElementById('editMedicineId').value = medicine.id;
                document.getElementById('editMedicineName').value = medicine.name;
                document.getElementById('editQuantity').value = medicine.quantity;
                document.getElementById('editExpiryDate').value = medicine.expiryDate;
                new bootstrap.Modal(document.getElementById('editMedicineModal')).show();
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error loading medicine details',
                    background: '#eaf8fd',
                    color: '#00b0ea',
                });
            }
        }

        async function updateMedicine() {
            const id = document.getElementById('editMedicineId').value;
            let name = document.getElementById('editMedicineName').value;
            const quantity = document.getElementById('editQuantity').value;
            const expiryDate = document.getElementById('editExpiryDate').value;
            if (currentLang === 'ta') {
                name = await translateText(name, 'ta', 'en');
            }
            try {
                const response = await fetch(`http://localhost:8080/api/medicines/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id,
                        name,
                        quantity: parseInt(quantity),
                        expiryDate,
                        user: { id: user.id }
                    })
                });
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editMedicineModal')).hide();
                    Swal.fire({
                        icon: 'success',
                        title: t('Medicine Updated'),
                        showConfirmButton: false,
                        timer: 1200,
                        background: '#eaf8fd',
                        color: '#00b0ea',
                    });
                    loadMedicines();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: t('Error'),
                        text: t('Error updating medicine'),
                        background: '#eaf8fd',
                        color: '#00b0ea',
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: t('Error'),
                    text: t('Error updating medicine'),
                    background: '#eaf8fd',
                    color: '#00b0ea',
                });
            }
        }

        async function deleteMedicine(id) {
            Swal.fire({
                title: t('Delete Medicine'),
                text: t('Are you sure you want to delete this medicine?'),
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ff3b3b',
                cancelButtonColor: '#bbb',
                confirmButtonText: t('Yes, delete it'),
                background: '#eaf8fd',
                color: '#00b0ea',
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`http://localhost:8080/api/medicines/${id}`, {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            Swal.fire({
                                icon: 'success',
                                title: t('Medicine Deleted'),
                                showConfirmButton: false,
                                timer: 1200,
                                background: '#eaf8fd',
                                color: '#00b0ea',
                            });
                            loadMedicines();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: t('Error'),
                                text: t('Error deleting medicine'),
                                background: '#eaf8fd',
                                color: '#00b0ea',
                            });
                        }
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: t('Error'),
                            text: t('Error deleting medicine'),
                            background: '#eaf8fd',
                            color: '#00b0ea',
                        });
                    }
                }
            });
        }

        function logout() {
            Swal.fire({
                title: t('Logout'),
                text: t('Are you sure you want to logout?'),
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#00b0ea',
                cancelButtonColor: '#bbb',
                confirmButtonText: t('Yes, logout'),
                background: '#eaf8fd',
                color: '#00b0ea',
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('user');
                    Swal.fire({
                        icon: 'success',
                        title: t('Logged Out'),
                        showConfirmButton: false,
                        timer: 1200,
                        background: '#eaf8fd',
                        color: '#00b0ea',
                        didClose: () => {
                            window.location.href = '/index.html';
                        }
                    });
                }
            });
        }

        // --- Language and Translation ---
        const translations = {
            en: {
                'My Medicines': 'My Medicines',
                'Search by name or expiry date': 'Search by name or expiry date',
                'Add Medicine': 'Add Medicine',
                'Add New Medicine': 'Add New Medicine',
                'Medicine Name': 'Medicine Name',
                'Quantity': 'Quantity',
                'Expiry Date': 'Expiry Date',
                'Close': 'Close',
                'Edit Medicine': 'Edit Medicine',
                'Save Changes': 'Save Changes',
                'Logout': 'Logout',
                'All': 'All',
                'Unexpired': 'Unexpired',
                'Expiring Soon': 'Expiring Soon',
                'Expired': 'Expired',
                'Medicine Added': 'Medicine Added',
                'Medicine Updated': 'Medicine Updated',
                'Medicine Deleted': 'Medicine Deleted',
                'Error': 'Error',
                'Error loading medicines': 'Error loading medicines',
                'Error adding medicine': 'Error adding medicine',
                'Error updating medicine': 'Error updating medicine',
                'Error deleting medicine': 'Error deleting medicine',
                'Delete Medicine': 'Delete Medicine',
                'Are you sure you want to delete this medicine?': 'Are you sure you want to delete this medicine?',
                'Yes, delete it': 'Yes, delete it',
                'Logout': 'Logout',
                'Are you sure you want to logout?': 'Are you sure you want to logout?',
                'Yes, logout': 'Yes, logout',
                'Logged Out': 'Logged Out',
                'Speak': 'Speak',
                'Could not understand the date. Recognized: ': 'Could not understand the date. Recognized: ',
                'Please try again or type manually.': 'Please try again or type manually.',
                'Could not recognize a full date. Please try again or type manually.': 'Could not recognize a full date. Please try again or type manually.',
                'Recognized speech: ': 'Recognized speech: ',
            },
            ta: {
                'My Medicines': 'என் மருந்துகள்',
                'Search by name or expiry date': 'பெயர் அல்லது காலாவதி தேதியால் தேடு',
                'Add Medicine': 'மருந்து சேர்க்க',
                'Add New Medicine': 'புதிய மருந்து சேர்க்க',
                'Medicine Name': 'மருந்து பெயர்',
                'Quantity': 'அளவு',
                'Expiry Date': 'காலாவதி தேதி',
                'Close': 'மூடு',
                'Edit Medicine': 'மருந்தை திருத்து',
                'Save Changes': 'மாற்றங்களை சேமி',
                'Logout': 'வெளியேறு',
                'All': 'அனைத்தும்',
                'Unexpired': 'காலாவதி ஆகாதவை',
                'Expiring Soon': 'விரைவில் காலாவதி',
                'Expired': 'காலாவதி ஆனவை',
                'Medicine Added': 'மருந்து சேர்க்கப்பட்டது',
                'Medicine Updated': 'மருந்து புதுப்பிக்கப்பட்டது',
                'Medicine Deleted': 'மருந்து நீக்கப்பட்டது',
                'Error': 'பிழை',
                'Error loading medicines': 'மருந்துகளை ஏற்றுவதில் பிழை',
                'Error adding medicine': 'மருந்து சேர்க்க பிழை',
                'Error updating medicine': 'மருந்து புதுப்பிக்க பிழை',
                'Error deleting medicine': 'மருந்து நீக்க பிழை',
                'Delete Medicine': 'மருந்தை நீக்கு',
                'Are you sure you want to delete this medicine?': 'இந்த மருந்தை நீக்க விரும்புகிறீர்களா?',
                'Yes, delete it': 'ஆம், நீக்கு',
                'Logout': 'வெளியேறு',
                'Are you sure you want to logout?': 'நீங்கள் வெளியேற விரும்புகிறீர்களா?',
                'Yes, logout': 'ஆம், வெளியேறு',
                'Logged Out': 'வெளியேறப்பட்டது',
                'Speak': 'பேசவும்',
                'Could not understand the date. Recognized: ': 'தேதியை புரிந்துகொள்ள முடியவில்லை. கண்டறியப்பட்டது: ',
                'Please try again or type manually.': 'மீண்டும் முயற்சிக்கவும் அல்லது கைமுறையாக உள்ளிடவும்.',
                'Could not recognize a full date. Please try again or type manually.': 'முழு தேதியை கண்டறிய முடியவில்லை. மீண்டும் முயற்சிக்கவும் அல்லது கைமுறையாக உள்ளிடவும்.',
                'Recognized speech: ': 'அறியப்பட்ட உரை: ',
            }
        };
        let currentLang = 'en';
        // On page load, check for saved language
        const savedLang = localStorage.getItem('lang');
        if (savedLang) currentLang = savedLang;
        function t(key) {
            return translations[currentLang][key] || key;
        }
        function updateTexts() {
            document.getElementById('dashboardTitle').textContent = t('My Medicines');
            document.getElementById('searchBar').placeholder = t('Search by name or expiry date');
            document.getElementById('addMedicineBtnText').textContent = t('Add Medicine');
            document.getElementById('addMedicineModalTitle').textContent = t('Add New Medicine');
            document.getElementById('addMedNameLabel').textContent = t('Medicine Name');
            document.getElementById('addMedQtyLabel').textContent = t('Quantity');
            document.getElementById('addMedExpLabel').textContent = t('Expiry Date');
            document.getElementById('addMedSubmitBtn').textContent = t('Add Medicine');
            document.getElementById('editMedicineModalTitle').textContent = t('Edit Medicine');
            document.getElementById('editMedNameLabel').textContent = t('Medicine Name');
            document.getElementById('editMedQtyLabel').textContent = t('Quantity');
            document.getElementById('editMedExpLabel').textContent = t('Expiry Date');
            document.getElementById('editMedSubmitBtn').textContent = t('Save Changes');
            document.getElementById('logoutBtnText').textContent = t('Logout');
            document.getElementById('all-tab').textContent = t('All');
            document.getElementById('unexpired-tab').textContent = t('Unexpired');
            document.getElementById('expiring-soon-tab').textContent = t('Expiring Soon');
            document.getElementById('expired-tab').textContent = t('Expired');
            document.querySelector('.footer').textContent = 'Developed by Durga 2025';
            document.getElementById('addMedMicBtn').title = t('Speak');
            document.getElementById('editMedMicBtn').title = t('Speak');
            document.getElementById('addQtyMicBtn').title = t('Speak');
            document.getElementById('editQtyMicBtn').title = t('Speak');
            document.getElementById('addExpMicBtn').title = t('Speak');
            document.getElementById('editExpMicBtn').title = t('Speak');
            // Re-render cards in the current language
            filterMedicines();
        }
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ta' : 'en';
            localStorage.setItem('lang', currentLang);
            updateTexts();
        }

        // --- Medicine Name Translation ---
        async function translateText(text, from, to) {
            // For demo: use Google Translate API (replace with your own endpoint if needed)
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${from}&tl=${to}&dt=t&q=${encodeURIComponent(text)}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                return data[0][0][0];
            } catch {
                return text;
            }
        }

        // --- Speech-to-Text Logic ---
        let recognition;
        function startSpeech(mode, field) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                Swal.fire({ icon: 'error', title: t('Error'), text: t('Speech recognition not supported'), background: '#eaf8fd', color: '#00b0ea' });
                return;
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = currentLang === 'en' ? 'en-US' : 'ta-IN';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = function(event) {
                let transcript = event.results[0][0].transcript;
                console.log('Recognized speech:', transcript);
                if (field.toLowerCase().includes('date')) {
                    const parsed = parseDateSpeech(transcript);
                    if (typeof parsed === 'object' && parsed.partial) {
                        document.getElementById(field).value = transcript;
                        Swal.fire({
                            icon: 'warning',
                            title: t('Error'),
                            text: t('Could not recognize a full date. Please try again or type manually.') + '\n' + t('Recognized speech: ') + transcript,
                            background: '#eaf8fd',
                            color: '#00b0ea',
                        });
                    } else if (parsed) {
                        document.getElementById(field).value = parsed;
                    } else {
                        document.getElementById(field).value = transcript;
                        Swal.fire({
                            icon: 'warning',
                            title: t('Error'),
                            text: t('Could not understand the date. Recognized: ') + transcript + '. ' + t('Please try again or type manually.'),
                            background: '#eaf8fd',
                            color: '#00b0ea',
                        });
                    }
                } else {
                    document.getElementById(field).value = transcript;
                }
            };
            recognition.onerror = function(event) {
                Swal.fire({ icon: 'error', title: t('Error'), text: event.error, background: '#eaf8fd', color: '#00b0ea' });
            };
            recognition.start();
        }

        // --- Fix date speech input: parse spoken date and set input value in YYYY-MM-DD ---
        function parseDateSpeech(text) {
            // Try to parse common date formats
            const months = {
                january: 1, february: 2, march: 3, april: 4, may: 5, june: 6,
                july: 7, august: 8, september: 9, october: 10, november: 11, december: 12,
                'ஜனவரி': 1, 'பிப்ரவரி': 2, 'மார்ச்': 3, 'ஏப்ரல்': 4, 'மே': 5, 'ஜூன்': 6,
                'ஜூலை': 7, 'ஆகஸ்ட்': 8, 'செப்டம்பர்': 9, 'அக்டோபர்': 10, 'நவம்பர்': 11, 'டிசம்பர்': 12
            };
            text = text.toLowerCase().replace(/\./g, '');
            // e.g. "May 20 2025" or "20 May 2025" or "20-05-2025" or tamil months
            let d, m, y;
            // 1. Try DD-MM-YYYY or D-M-YYYY
            let match = text.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})/);
            if (match) {
                d = match[1]; m = match[2]; y = match[3];
            } else {
                // 2. Try "May 20 2025" or "20 May 2025" or tamil
                match = text.match(/(\d{1,2})\s+([a-z\u0B80-\u0BFF]+)\s+(\d{4})/);
                if (match) {
                    d = match[1]; m = months[match[2]]; y = match[3];
                } else {
                    match = text.match(/([a-z\u0B80-\u0BFF]+)\s+(\d{1,2})\s+(\d{4})/);
                    if (match) {
                        m = months[match[1]]; d = match[2]; y = match[3];
                    } else {
                        // 3. Try "20 5 2025" (DD MM YYYY)
                        match = text.match(/(\d{1,2})\s+(\d{1,2})\s+(\d{4})/);
                        if (match) {
                            d = match[1]; m = match[2]; y = match[3];
                        } else {
                            // 4. Try only two numbers (not enough for a date)
                            match = text.match(/(\d{1,2})\s+(\d{4})/);
                            if (match) {
                                // Not enough info, return empty and let the handler show a SweetAlert
                                return { partial: true, recognized: text };
                            }
                        }
                    }
                }
            }
            if (d && m && y) {
                if (m < 10) m = '0' + m;
                if (d < 10) d = '0' + d;
                return `${y}-${m}-${d}`;
            }
            // fallback: return empty
            return '';
        }
    </script>
    <footer class="footer">
        Developed by Durga 2025
    </footer>
</body>
</html> 